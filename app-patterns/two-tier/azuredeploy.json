{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
	"operatingSystem": {
      "type": "string",
      "defaultValue": "Ubuntu",
      "metadata": {
        "description": "Operating System of the Server"
      },
      "allowedValues": [
        "Server2012R2",
        "Server2016",
		"Ubuntu"
      ]
    },
	"customData": {
      "type": "string",
      "defaultValue": "#cloud-config\n\nruncmd:\n- apt-get update\n- apt-get install nginx -y",
      "metadata": {
        "description": "String passed down to the Virtual Machine."
      }
	},
	"tier1NamePrefix": {
      "type": "string",
      "defaultValue": "web",
      "metadata": {
        "description": "tier1 Name Prefix"
		}
    },
	"tier2NamePrefix": {
      "type": "string",
      "defaultValue": "app",
      "metadata": {
        "description": "tier1 Name Prefix"
      }
    },
	"networkresourcegroupname": {
      "type": "string",
      "defaultValue": "upstream-ne-prod",
      "metadata": {
        "description": "networkresourcegroupname"
      }
    },
	"virtualNetworkName": {
      "type": "string",
      "defaultValue": "ne-prod",
      "metadata": {
        "description": "virtualNetworkName"
      }
    },
	"tier1subnetName": {
      "type": "string",
      "defaultValue": "ne-prod-web",
      "metadata": {
        "description": "tier1subnetName"
      }
    },
	"tier1subnetNameIlb": {
      "type": "string",
      "defaultValue": "ne-prod-web-ilb",
      "metadata": {
        "description": "tier1subnetNameIlb"
      }
    },
	"tier2subnetName": {
      "type": "string",
      "defaultValue": "ne-prod-app",
      "metadata": {
        "description": "tier2subnetName"
      }
    },
	"tier2subnetNameIlb": {
      "type": "string",
      "defaultValue": "ne-prod-app-ilb",
      "metadata": {
        "description": "tier2subnetNameIlb"
      }
    }
   
  },
  "variables": {
    
	"subscriptionId" : "[subscription().subscriptionId]",
	
	"networkresourcegroupname" : "[parameters('networkresourcegroupname')]",
	"virtualNetworkName" : "[parameters('virtualNetworkName')]",

	"tier1subnetName" : "[parameters('tier1subnetName')]",
	"tier1subnetNameIlb" : "[parameters('tier1subnetNameIlb')]",
	"tier2subnetName" : "[parameters('tier2subnetName')]",
	"tier2subnetNameIlb" : "[parameters('tier2subnetNameIlb')]",
	
	"vnetID": "[resourceId(variables('subscriptionId'), variables('networkresourcegroupname'), 'Microsoft.Network/virtualNetworks', variables('virtualNetworkName'))]",
	
	"asgRemoteIdtoGainAccess": "[concat(variables('vnetID'), crosoft.Network/applicationSecurityGroups/upstream-app1app-allowed-toaccess-asg",
	
    "storageAccountType": "Standard_LRS",
    "numberOfInstances": 3,    
	"vmSize" : "Standard_DS1",
	
	"tier1NamePrefix": "[concat(resourceGroup().name, parameters('tier1NamePrefix') )]",
	"tier1VMSubnetRef":  "[concat(variables('vnetID'), '/subnets/', variables('tier1subnetName'))]",
	"tier1IlbSubnetRef":  "[concat(variables('vnetID'), '/subnets/', variables('tier1subnetNameIlb'))]",
	
	"tier1lbname": "[concat('Microsoft.Network/loadBalancers/', variables('tier1NamePrefix'),'-ilb')]",
	"tier1lbID": "[resourceId('Microsoft.Network/loadBalancers', concat(variables('tier1NamePrefix'),'-ilb'))]",
	"tier1asgID": "[resourceId('Microsoft.Network/applicationSecurityGroups',concat(variables('tier1NamePrefix'),'-asg'))]",
	"tier1asgAllowedToAccessID": "[resourceId(variables('networkresourcegroupname'), 'Microsoft.Network/applicationSecurityGroups',concat(variables('tier1NamePrefix'),'-allowed-toaccess-asg'))]",
	"tier1nsgID": "[resourceId('Microsoft.Network/networkSecurityGroups',concat(variables('tier1NamePrefix'),'-app-nsg'))]",
	
	"tier2NamePrefix": "[concat(resourceGroup().name, parameters('tier2NamePrefix'))]",
	"tier2VMSubnetRef":  "[concat(variables('vnetID'), '/subnets/', variables('tier2subnetName'))]",
	"tier2IlbSubnetRef":  "[concat(variables('vnetID'), '/subnets/', variables('tier2subnetNameIlb'))]",
	
	"tier2lbname": "[concat('Microsoft.Network/loadBalancers/', variables('tier2NamePrefix'),'-ilb')]",
	"tier2lbID": "[resourceId('Microsoft.Network/loadBalancers', concat(variables('tier2NamePrefix'),'-ilb'))]",
	"tier2asgID": "[resourceId('Microsoft.Network/applicationSecurityGroups',concat(variables('tier2NamePrefix'),'-asg'))]",
	"tier2asgAllowedToAccessID": "[resourceId(variables('networkresourcegroupname'), 'Microsoft.Network/applicationSecurityGroups',concat(variables('tier2NamePrefix'),'-allowed-toaccess-asg'))]",
	"tier2nsgID": "[resourceId('Microsoft.Network/networkSecurityGroups',concat(variables('tier2NamePrefix'),'-app-nsg'))]",
		
	"tier3NamePrefix": "db",
	"operatingSystemValues": {
      "Server2012R2": {
        "PublisherValue": "MicrosoftWindowsServer",
        "OfferValue": "WindowsServer",
        "SkuValue": "2012-R2-Datacenter"
      },
      "Server2016": {
        "PublisherValue": "MicrosoftWindowsServer",
        "OfferValue": "WindowsServer",
        "SkuValue": "2016-Datacenter"
      },
	  "Ubuntu": {
		  "PublisherValue": "Canonical",
		  "OfferValue": "UbuntuServer",
		  "SkuValue": "16.04.0-LTS",
		  "version": "latest"
	  }
    },
	"adminUsername": "uday",
	"adminPassword": "!!123abc!!123abc"
  },
  "resources": [
   
   {
		"apiVersion": "2017-05-10",
		"name": "[concat(variables('tier1NamePrefix'), '-deployment')]",
		"type": "Microsoft.Resources/deployments",		
		"properties": {
			"mode": "Incremental",
			"templateLink":{
				"uri": "https://raw.githubusercontent.com/uday31in/arm-sample/master/app-patterns/two-tier/xTierDeployment.json"
			},
			"parameters": {
				"operatingSystem":{
					"value": "[parameters('operatingSystem')]"
				},
				"customData":{
					"value": "[parameters('customData')]"
				},
				"tierXNamePrefix":{
					"value": "[parameters('tier1NamePrefix')]"
				},
				"networkresourcegroupname":{
					"value": "[parameters('networkresourcegroupname')]"
				},
				"virtualNetworkName":{
					"value": "[parameters('virtualNetworkName')]"
				},
				"tierXsubnetName":{
					"value": "[parameters('tier1subnetName')]"
				},
				"tierXsubnetNameIlb":{
					"value": "[parameters('tier1subnetNameIlb')]"
				}
			}
		}
    },
	
	 {
		"apiVersion": "2017-05-10",
		"name": "[concat(variables('tier2NamePrefix'), '-deployment')]",
		"type": "Microsoft.Resources/deployments",		
		"properties": {
			"mode": "Incremental",
			"templateLink":{
				"uri": "https://raw.githubusercontent.com/uday31in/arm-sample/master/app-patterns/two-tier/xTierDeployment.json"
			},
			"parameters": {
				"operatingSystem":{
					"value": "[parameters('operatingSystem')]"
				},
				"customData":{
					"value": "[parameters('customData')]"
				},
				"tierXNamePrefix":{
					"value": "[parameters('tier2NamePrefix')]"
				},
				"networkresourcegroupname":{
					"value": "[parameters('networkresourcegroupname')]"
				},
				"virtualNetworkName":{
					"value": "[parameters('virtualNetworkName')]"
				},
				"tierXsubnetName":{
					"value": "[parameters('tier2subnetName')]"
				},
				"tierXsubnetNameIlb":{
					"value": "[parameters('tier2subnetNameIlb')]"
				}
			}
		}
    },
   
   	
	
  ]
}
